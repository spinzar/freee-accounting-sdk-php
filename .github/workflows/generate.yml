name: Generate

on:
  pull_request:
    branches: [ master ]

env:
  PACKAGE_NAME: freee/freee-accounting-sdk
  SCHEMA_URL: https://gist.githubusercontent.com/shibayan/3fdf5a66554e5e7ccfe4cc8350db86d7/raw/64548c7ad8bb4c65c0bbe1748ca8f759da648aa6/api-schema.yml
  KEEP_CURRENT_HEADER_SELECTOR: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - name: Install packages
      run: |
        sudo snap install yq

    - uses: actions/checkout@v2

    - name: Remove old codes
      run: |
        rm -rf .openapi-generator/VERSION docs lib test .php_cs .travis.yml git_push.sh phpunit.xml.dist

    - name: Update lib version
      run: |
        yq w .openapi-generator/config.yml artifactVersion v2.0.0-test

    - name: Generate APIs
      run: |
        docker run --rm -u "$(id -u $USER):$(id -g $USER)" -v "${PWD}:/local" openapitools/openapi-generator-cli:latest-release generate \
          -i ${{ env.SCHEMA_URL }} \
          -c /local/.openapi-generator/config.yml \
          -g php \
          -o /local/
        rm -rf .travis.yml git_push.sh
        mv -f README.md README_auto-generated.md
        sed -i -e 's#"freee/freee-accounting-sdk-php"#"${{ env.PACKAGE_NAME }}"#g' README_auto-generated.md
        git checkout README.md

    - name: Maintain composer.json
      run: |
        cat composer.json | jq --indent 4 '. | .name = "${{ env.PACKAGE_NAME }}" | .type = "library" | .description = "Accounting freee PHP SDK" | .keywords += ["api"] | .homepage = "https://developer.freee.co.jp/" | .license = "MIT" | .authors[0].name = "Freee" | .authors[0].homepage = "https://developer.freee.co.jp/"' > composer.json.tmp
        mv -f composer.json.tmp composer.json

    - name: Revert HeaderSelector
      if: ${{ env.KEEP_CURRENT_HEADER_SELECTOR }}
      run: |
        git checkout lib/HeaderSelector.php

    - name: Git
      run: |
        git fetch
        git checkout master
        git config --local user.name "API Generator"
        git add .
        git commit -m "Generated by TAG_NAME"
        git reset --hard HEAD
        git clean -fdx

    - name: Create pull request
      uses: peter-evans/create-pull-request@v3